<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/optimus/blog/rss.xml" title="Optimus Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/optimus/blog/atom.xml" title="Optimus Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RSCK0YREFM"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RSCK0YREFM",{})</script><title data-react-helmet="true">Developing plugins | Optimus</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://odpf.github.io/optimus/docs/development/building-plugin"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Developing plugins | Optimus"><meta data-react-helmet="true" name="description" content="Optimus&#x27;s responsibilities are currently divided in two parts, scheduling a transformation task and running one time action to create or modify a datastore resource. Defining how a datastore is managed can be easy and doesn&#x27;t leave many options for configuration or ambiguity although the way datastores are implemented gives developers flexibility to contribute additional type of datastore, but it is not something we do every day."><meta data-react-helmet="true" property="og:description" content="Optimus&#x27;s responsibilities are currently divided in two parts, scheduling a transformation task and running one time action to create or modify a datastore resource. Defining how a datastore is managed can be easy and doesn&#x27;t leave many options for configuration or ambiguity although the way datastores are implemented gives developers flexibility to contribute additional type of datastore, but it is not something we do every day."><link data-react-helmet="true" rel="shortcut icon" href="/optimus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://odpf.github.io/optimus/docs/development/building-plugin"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/development/building-plugin" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/development/building-plugin" hreflang="x-default"><link rel="stylesheet" href="/optimus/assets/css/styles.7914c5d7.css">
<link rel="preload" href="/optimus/assets/js/runtime~main.c4e32d73.js" as="script">
<link rel="preload" href="/optimus/assets/js/main.40830ef5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#222;color:#eee" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">⭐️ If you like Optimus, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/odpf/optimus">GitHub</a>! ⭐</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/optimus/"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Optimus</b></a><a class="navbar__item navbar__link navbar__link--active" href="/optimus/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/optimus/blog">Blog</a><a class="navbar__item navbar__link" href="/optimus/help">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link"></a><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-item-github"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">☾</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">☀️</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/optimus/docs/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist" href="#">Getting Started</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/optimus/docs/getting-started/installation">Installation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/optimus/docs/getting-started/configuration">Configurations</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Guides</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Development</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/optimus/docs/development/building-plugin">Developing plugins</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Contribute</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/optimus/docs/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Reference</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Developing plugins</h1></header><p>Optimus&#x27;s responsibilities are currently divided in two parts, scheduling a transformation <a href="/optimus/docs/concepts/overview#Job">task</a> and running one time action to create or modify a <a href="/optimus/docs/concepts/overview#Datastore">datastore</a> resource. Defining how a datastore is managed can be easy and doesn&#x27;t leave many options for configuration or ambiguity although the way datastores are implemented gives developers flexibility to contribute additional type of datastore, but it is not something we do every day.</p><p>Whereas tasks used in jobs that define how the transformation will execute, what configuration does it need as input from user, how does this task resolves dependencies between each other, what kind of assets it might need. These questions are very open and answers to them could be different in  different organisation and users. To allow flexibility of answering these questions by developers themselves, we have chosen to make it easy to  contribute a new kind of task or even a hook. This modularity in Optimus is achieved using plugins.</p><p>Optimus can be divided in two logical parts when we are thinking of a pluggable model, one is the <strong>core</strong> where everything happens which is common for all job/datastore, and the other part which could be variable and needs user specific definitions of how things should work which is a <strong>plugin</strong>.</p><p>Currently Optimus plugin can be implemented as binary executable.
And <code>support for yaml</code> implementation of plugins is also introduced with limited
scope (discussed below).</p><p>Optimus Plugin is just an adapter between optimus and  what actually needs to be executed. Actual transformation will be packed in a docker image and Optimus will execute these arbitrary docker images as long as it has access to reach container registry. Plugin provides the optimus server with the info about the docker image.</p><blockquote><p>Plugin itself is not executed for transformation but only used for adapting conditions which Optimus requires to be defined for each task.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="types-of-plugins-in-optimus"></a>Types of Plugins in Optimus<a class="hash-link" href="#types-of-plugins-in-optimus" title="Direct link to heading">#</a></h2><p>At the moment mainly there are two types of plugins which optimus supports. These are : <strong><em>Hook</em></strong> and  <strong><em>Task</em></strong>
Before getting into the difference between two plugins ,we need to get familiar with <a href="/optimus/docs/concepts/overview#Job">Jobs</a>.</p><table><thead><tr><th>Type</th><th>Task</th><th>Hook</th></tr></thead><tbody><tr><td>Definition</td><td>It is the single base transformation in a Job.</td><td>It is the operation that we preferably run before or after a Job.</td></tr><tr><td>Fundamental Difference</td><td>It can have dependencies over other jobs inside the Optimus project.</td><td>It can have dependencies over other hooks within the job.</td></tr><tr><td>Configuration</td><td>It has its own set of configs and asset directory.</td><td>It has its own set of configs and share the same asset directory across all hooks as the base job.</td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="supported-use-cases-of-plugins-in-optimus"></a>Supported Use-Cases of Plugins in Optimus<a class="hash-link" href="#supported-use-cases-of-plugins-in-optimus" title="Direct link to heading">#</a></h2><ul><li>Plugin Info Usecases: <ul><li>Discover all plugins and list their info.</li><li>Refer - <code>optimus version</code> (lists all the plugins available),</li></ul></li><li>Project Side Usecases :<ul><li>Survey to populate job specifications and assets.</li><li>Plugins provide the questionare and default values (default assets for job) to the survey implemtnation in optimus.</li><li>Refer -  <code>optimus job create</code></li></ul></li><li>Server Side Usecases :<ul><li>CompileAssets &amp; DependencyResolver</li><li>Theses are currently supported server side behaviour that is delegated to plugins implementations.</li><li>Refer - <a href="https://github.com/odpf/transformers/blob/main/task/bq2bq/main.go#L274" target="_blank" rel="noopener noreferrer">transformers</a> </li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="binary-implementation-of-plugin"></a>Binary Implementation of Plugin<a class="hash-link" href="#binary-implementation-of-plugin" title="Direct link to heading">#</a></h2><p>Binary implementation of Plugins are self-contained binaries which implements predefined protobuf interfaces to extend Optimus functionalities.
Binary Plugins are implemented using <a href="https://github.com/hashicorp/go-plugin" target="_blank" rel="noopener noreferrer">go-plugin</a> developed by Hashicorp used in terraform and other similar products. </p><blockquote><p>Plugins can be implemented in any language as long as they can be exported as a single self-contained executable binary and implements a GRPC server. </p></blockquote><p>It is recommended to use Go currently for writing plugins because of its cross platform build functionality and to reuse protobuf sdk provided within Optimus core. </p><blockquote><p>Binary Plugins can potentially modify the behavior of Optimus in undesired ways. Exercise caution when adding new plugins developed by unrecognized developers.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="yaml-implementation-of-plugin"></a>Yaml Implementation of Plugin<a class="hash-link" href="#yaml-implementation-of-plugin" title="Direct link to heading">#</a></h2><p>Most plugins are expected to implement just the info and project side use-cases (mentioned above) and thease are data-driven i.e., plugin just provide data to optimus.
To simplify the development process of plugins, support for yaml mode of defining plugins is added.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// representation of a yaml plugin schema in golang</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// below struct definition in golang can be marshalled </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// to generate yaml plugins</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> YamlPlugin </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// info use-case</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name          </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;name&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Description   </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;description&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Plugintype    </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;plugintype&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pluginversion </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;pluginversion&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image         </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;image&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Secretpath    </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;secretpath&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// survey use-case</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Questions     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name            </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;name&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Prompt          </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;prompt&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Help            </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;help&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Regexp          </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;regexp&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Validationerror </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;validationerror&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Minlength       </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`yaml:&quot;minlength&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Required        </span><span class="token builtin">bool</span><span class="token plain">     </span><span class="token string" style="color:#e3116c">`yaml:&quot;required,omitempty&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Maxlength       </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`yaml:&quot;maxlength,omitempty&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Subquestions    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Ifvalue   </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;ifvalue&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Questions </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Name        </span><span class="token builtin">string</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">`yaml:&quot;name&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Prompt      </span><span class="token builtin">string</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">`yaml:&quot;prompt&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Help        </span><span class="token builtin">string</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">`yaml:&quot;help&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Multiselect </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;multiselect&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Regexp          </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;regexp&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Validationerror </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;validationerror&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Minlength       </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`yaml:&quot;minlength&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Required        </span><span class="token builtin">bool</span><span class="token plain">     </span><span class="token string" style="color:#e3116c">`yaml:&quot;required,omitempty&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Maxlength       </span><span class="token builtin">int</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">`yaml:&quot;maxlength,omitempty&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;questions&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;subquestions,omitempty&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;questions&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// default-static-values use-case</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Defaultassets </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name  </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;name&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Value </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;value&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;defaultassets&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Defaultconfig </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name  </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;name&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Value </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;value&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`yaml:&quot;defaultconfig&quot;`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>refer to sample implemenation <a href="#2a-creating-a-yaml-plugin">here</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="limitations-of-yaml-plugins"></a>Limitations of Yaml plugins:<a class="hash-link" href="#limitations-of-yaml-plugins" title="Direct link to heading">#</a></h3><p>Here the scope of yaml plugins is limited to drive survey, provide default values for job config and assets and provide plugin info. As majoiry of the plugins are expected to implement subset these use-cases, the support for yaml definitions for plugins is added which simplifies development, packaging and distribution of plugins.</p><p>For plugins that require to enrich optimus server side behaviour, yaml definitions falls short as this would require some code.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="validating-yaml-plugins"></a>Validating Yaml plugins:<a class="hash-link" href="#validating-yaml-plugins" title="Direct link to heading">#</a></h3><p>Also support for validating yaml plugin is added into optimus.
After creating yaml definitions of plugin, one can validate them as below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus plugin validate --path </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">directory of yaml plugins</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>** Note: The yaml plugin is expected to have file name as <code>optimus-plugin-{{name}}.yaml</code></p><p>** Note: If Both yaml and binary plugin with same name are installed, Yaml implementation is prioritised over the corresponding counterparts in binary implemenation.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="creating-plugin--tutorial"></a>Creating Plugin : Tutorial<a class="hash-link" href="#creating-plugin--tutorial" title="Direct link to heading">#</a></h2><p>To demonstrate the above mentioned wrapping functionality, let&#x27;s create a plugin in Go as well as a yaml definition and use python for actual transformation logic. You can choose to fork this <a href="https://github.com/kushsharma/optimus-plugins" target="_blank" rel="noopener noreferrer">example</a> template and modify it as per your needs or start fresh. To demonstrate how to start from scratch, we will be starting from an empty git repository and build a plugin which will find potential hazardous <strong>Near Earth Orbit</strong> objects every day, let&#x27;s call it <strong>neo</strong> for short. </p><p>Brief description of Neo is as follows</p><ul><li>Using  <a href="https://api.nasa.gov/" target="_blank" rel="noopener noreferrer">NASA API</a> we can get count of hazardous objects, their diameter and velocity.</li><li>Task will need two config as input, <code>RANGE_START</code>, <code>RANGE_END</code> as date time string which will filter the count for this specific period only.</li><li>Execute every day, say at 2 AM.</li><li>Need a secret token that will be passed to NASA api endpoint for each request.</li><li>Output of this object count can be printed in logs for now but in a real use case can be pushed to Kafka topic or written to a database.</li><li>Plugin will be written in <strong>Go</strong> and <strong>Neo</strong> in <strong>python</strong>.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="1-preparing-task-executor"></a>1. Preparing task executor<a class="hash-link" href="#1-preparing-task-executor" title="Direct link to heading">#</a></h3><p>Start by initialising an empty git repository with the following folder structure</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">.git</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /neo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /executor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /main.py</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /requirements.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /Dockerfile</span></span><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>That is three folders one inside another. This might look confusing for now, a lot of things will, but just keep going. Create an empty python file in executor <code>main.py</code>, this is where the main logic for interacting with nasa api and generating output will be. For simplicity, lets use as minimal things as possible.</p><p>Add the following code to <code>main.py</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> requests</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> json</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Sends a http call to nasa api, parses response and prints potential hazardous</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    objects in near earth orbit</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return:</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    opt_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fetch_config_from_optimus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># user configuration for date range</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    range_start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> opt_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;envs&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;RANGE_START&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    range_end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> opt_config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;envs&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;RANGE_END&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    secret_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;SECRET_KEY&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># secret token required for NASA API being passed using job spec</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    api_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secret_key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> api_key </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;invalid api token&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># send the request for given date range</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://api.nasa.gov/neo/rest/v1/feed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     params</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;start_date&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> range_start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;end_date&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> range_end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;api_key&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> api_key</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># extracting data in json format</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;for date range {} - {}&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">range_start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> range_end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    print_details</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch_config_from_optimus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Fetch configuration inputs required to run this task for a single schedule day</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Configurations are fetched using optimus rest api</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return:</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># try printing os env to see what all we have for debugging</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># print(os.environ)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># prepare request</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimus_host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;OPTIMUS_HOSTNAME&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduled_at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;SCHEDULED_AT&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    project_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;PROJECT&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    job_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;JOB_NAME&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;http://{}/api/v1/project/{}/job/{}/instance&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">optimus_host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> project_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> job_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      json</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;scheduled_at&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> scheduled_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token string" style="color:#e3116c">&#x27;instance_name&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;neo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token string" style="color:#e3116c">&#x27;instance_type&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TASK&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># print(instance)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>api_key</code> is a token provided by nasa during registration. This token will be passed as a parameter in each http call. <code>SECRET_PATH</code> is the path to a file which will contain this token in json and will be mounted inside the docker container by Optimus.</p><p><code>start</code> function is using <code>fetch_config_from_optimus()</code> to get the date range for which this task executes for an iteration. In this example, configuration is fetched using REST APIs provided by optimus although there are variety of ways to get them. After extracting <code>API_KEY</code> from secret file, unmarshalling it to json with <code> json.load()</code> send a http request to nasa api. Response can be parsed and printed using the following function</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">print_details</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Parse and calculate what we need from NASA endpoint response</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c">
</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param jd: json data fetched from NASA API</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return:</span></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    element_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;element_count&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    potentially_hazardous </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> search_date </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> jd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;near_earth_objects&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> neo </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> jd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;near_earth_objects&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">search_date</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> neo</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;is_potentially_hazardous_asteroid&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                potentially_hazardous</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> neo</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;estimated_diameter_km&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> neo</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;estimated_diameter&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;kilometers&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;estimated_diameter_max&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;relative_velocity_kmh&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> neo</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;close_approach_data&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;relative_velocity&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;kilometers_per_hour&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;total tracking: {}\npotential hazardous: {}&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">element_count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">potentially_hazardous</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> haz </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> potentially_hazardous</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Name: {}\nEstimated Diameter: {} km\nRelative Velocity: {} km/h\n\n&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            haz</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            haz</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;estimated_diameter_km&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            haz</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;relative_velocity_kmh&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Finish it off by adding the main function</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Add <code>requests</code> library in <code>requirements.txt</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ini"><pre tabindex="0" class="prism-code language-ini codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">requests==v2.25.1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once the python code is ready, wrap this in a <code>Dockerfile</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly dockerfile"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># set base image (host OS)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM python:3.8</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># set the working directory in the container</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p /opt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /opt</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># copy the content of the local src directory to the working directory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY task/neo/executor .</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># install dependencies</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install -r requirements.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [&quot;python3&quot;, &quot;main.py&quot;]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="2a-creating-a-yaml-plugin"></a>2a. Creating a yaml plugin<a class="hash-link" href="#2a-creating-a-yaml-plugin" title="Direct link to heading">#</a></h3><p>The Yaml implementation is as simple as providing the plugin details as below.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Neo</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Near earth object tracker</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">plugintype</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> task</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pluginversion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ghcr.io/kushsharma/optimus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">neo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">executor</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">secretpath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /tmp/.secrets</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">questions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RANGE_START</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prompt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Date range start</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">help</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> YYYY</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">MM</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">DD format</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">required</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RANGE_END</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prompt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Date range end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">help</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> YYYY</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">MM</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">DD format</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">required</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Based on the usecase, additional validation can be added to the questions section. Refer <a href="#yaml-implementation-of-plugin">above</a> for more usecases and features provided.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="2b-creating-a-binary-plugin"></a>2b. Creating a binary plugin<a class="hash-link" href="#2b-creating-a-binary-plugin" title="Direct link to heading">#</a></h3><p>At the moment Optimus supports task as well as hook plugins. In this section we will be explaining how to write a new task although both are very similar. </p><p>Now that base image is ready for execution, this needs to be scheduled at a fixed interval using <code>jobs</code> but for optimus to understand <strong>Neo</strong> task, we need to write an adapter for it.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="implementing-plugin-interface"></a>Implementing plugin interface<a class="hash-link" href="#implementing-plugin-interface" title="Direct link to heading">#</a></h4><p>Because we are using Go, start by initialising Go module in <code>neo</code> directory as follows</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> mod init github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kushsharma</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">optimus</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">plugins</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">task</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">neo</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Prepare <code>main.go</code> in the same directory structure</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">.git</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /neo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /executor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /main.py</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /requirements.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /Dockerfile</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /main.go</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /go.mod</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /go.sum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Start by adding the following boilerplate code</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;errors&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;strconv&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/hashicorp/go-hclog&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/odpf/optimus/internal/models&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/odpf/optimus/plugin&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/odpf/optimus/plugin/base&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;neo&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latest&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ghcr.io/kushsharma/optimus-task-neo-executor&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Neo </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log hclog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Logger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">Neo</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The plugin binary serves a GRPC server on start but before the communication channel is created protocol version, socket, port, and some other metadata needs to be printed as the handshake information to stdout which the core will read. Plugin and core needs to mutually conclude on same protocol version to start the communication. Client side protocol version announcement is done using <code>HandshakeConfig</code> provided in <code>main()</code>. </p><p><strong>Handshake contract:</strong>
CORE-PROTOCOL-VERSION | APP-PROTOCOL-VERSION | NETWORK-TYPE | NETWORK-ADDR | PROTOCOL</p><p><strong>For example:</strong> </p><p>1|1|tcp|127.0.0.1:1234|grpc</p><p>You don&#x27;t have to worry about this if you are using the provided <code>plugin.Serve</code> and all this happens automatically behind the scene. Core will initiate a connection with the plugin server as a client when the core binary boots and caches the connection for further internal use.</p><p>A single binary can serve more than one kind of plugin, in this example stick with just one. Each plugin is composed of one <code>base</code> plugin implementation and some additional optional <code>mods</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="base-plugin"></a>Base Plugin<a class="hash-link" href="#base-plugin" title="Direct link to heading">#</a></h4><p>Base plugin interface needs to be <a href="https://github.com/odpf/proton/blob/54e0bec2df4235cabea4ac2127534a468584e932/odpf/optimus/plugins/base.proto" target="_blank" rel="noopener noreferrer">implemented</a> by every plugin. It is responsible for providing plugin metadata to Optimus core.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly protobuf"><pre tabindex="0" class="prism-code language-protobuf codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">package odpf.optimus.plugins;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Base must be implemented by all plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">service Base {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // PluginInfo provides basic details for this plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpc PluginInfo(PluginInfoRequest) returns (PluginInfoResponse);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// PluginType enumerates the type of plugins Optimus supports</span></span><span class="token-line" style="color:#393A34"><span class="token plain">enum PluginType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginType_UNKNOWN = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginType_TASK = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginType_HOOK = 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// PluginMod enumerates the type of mods this plugin supports</span></span><span class="token-line" style="color:#393A34"><span class="token plain">enum PluginMod {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginMod_UNKNOWN = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginMod_CLI = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginMod_DEPENDENCYRESOLVER = 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// HookType enumerates the type of hook Optimus supports</span></span><span class="token-line" style="color:#393A34"><span class="token plain">enum HookType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HookType_UNKNOWN = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HookType_PRE = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HookType_POST = 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HookType_FAIL = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">message PluginInfoRequest {}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">message PluginInfoResponse {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    string name = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    string description = 2;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PluginType plugin_type = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated PluginMod plugin_mods = 4;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // plugin_version is the semver version of this individual plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    string plugin_version = 5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // api_versions indicates the versions of the Optimus Plugin API</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // this plugin supports</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated string api_version = 6;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // docker image including version if this executes a docker image</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    string image = 10;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // HOOK specific</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // name of hooks on which this should depend on before executing</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated string depends_on = 20;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HookType hook_type = 21;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Experimental</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // will be mounted inside the container as volume</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    string secret_path = 30;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If your plugin simply wants to register itself as task or hook for execution and nothing else then that&#x27;s it. You don&#x27;t need to implement anything else but for additional features we can implement plugin <code>mod</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="plugin-mods"></a>Plugin Mods<a class="hash-link" href="#plugin-mods" title="Direct link to heading">#</a></h4><p>Plugin can have none or many plugins mods being implemented at the same time. At the moment there are 2 mods available for usage</p><ol><li><a href="https://github.com/odpf/proton/blob/54e0bec2df4235cabea4ac2127534a468584e932/odpf/optimus/plugins/cli.proto" target="_blank" rel="noopener noreferrer">CLIMod</a>: It provides plugin to interact with Optimus cli. Plugin can provide default configs, ask questions from users to create job specification, override default asset macro compilation behaviour, etc.</li><li><a href="https://github.com/odpf/proton/blob/54e0bec2df4235cabea4ac2127534a468584e932/odpf/optimus/plugins/dependency_resolver.proto" target="_blank" rel="noopener noreferrer">DependencyResolverMod</a>: It provides plugin to implement automatic dependency resolution using assets/configs.</li></ol><p>In this example we will use the CLIMod.</p><p>To start serving GRPC, either we write our own implementation for serialising/deserialising Go structs to protobufs or reuse the one already provided by <a href="https://github.com/odpf/optimus/blob/eaa50bb37d7e738d9b8a94332312f34b04a7e16b/plugin/task/server.go" target="_blank" rel="noopener noreferrer">core</a>. Optimus GRPC server accepts an interface which we will implement next on Neo struct. Custom protobuf adapter can also be written using the <a href="https://github.com/odpf/proton/blob/54e0bec2df4235cabea4ac2127534a468584e932/odpf/optimus/plugins/base.proto" target="_blank" rel="noopener noreferrer">provided</a> protobuf stored in odpf <a href="https://github.com/odpf/proton" target="_blank" rel="noopener noreferrer">repository</a>.</p><p>Add the following code in the existing <code>main.go</code> as an implementation to <a href="https://github.com/odpf/proton/blob/54e0bec2df4235cabea4ac2127534a468584e932/odpf/optimus/plugins/base.proto" target="_blank" rel="noopener noreferrer">BasePlugin</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Neo </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// GetSchema provides basic task details</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Neo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PluginInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginInfoResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginInfoResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;Near earth object tracker&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginTypeTask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginMods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginMod</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ModTypeCLI</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Version</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        APIVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">strconv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Itoa</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ProtocolVersion</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// docker image that will be executed as the actual transformation task</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s:%s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You might have noticed we have specified at line number 9 that we are supporting <code>models.ModTypeCLI</code>. This will let Optimus know what all this plugin is capable of. Let&#x27;s implement the <a href="https://github.com/odpf/proton/blob/54e0bec2df4235cabea4ac2127534a468584e932/odpf/optimus/plugins/cli.proto" target="_blank" rel="noopener noreferrer">CLIMod</a> now.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// GetQuestions provides questions asked via optimus cli when a new job spec</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// is requested to be created</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Neo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetQuestions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GetQuestionsRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GetQuestionsResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    tQues </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginQuestion</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;Start&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Prompt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Date range start&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Help</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;YYYY-MM-DD format&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;End&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Prompt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Date range end&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Help</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">&quot;YYYY-MM-DD format&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GetQuestionsResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Questions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tQues</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ValidateQuestion validate how stupid user is</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Each question config in GetQuestions will send a validation request</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Neo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ValidateQuestion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ValidateQuestionRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ValidateQuestionResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Answer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Question</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Start&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ans </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ans</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ok </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> d </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;not a valid string&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// can choose to parse here for a valid date but we will use optimus</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// macros here {{.DSTART}} instead of actual dates</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// _, err := time.Parse(time.RFC3339, d)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// return err</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Answer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;End&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ans </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ans</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ok </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> d </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;not a valid string&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// can choose to parse here for a valid date but we will use optimus</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// macros here {{.DEND}} instead of actual dates</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// _, err := time.Parse(time.RFC3339, d)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// return err</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Answer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ValidateQuestionResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ValidateQuestionResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAnswerByName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> answers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginAnswer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginAnswer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ans </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> answers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ans</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Question</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> name </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ans</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginAnswer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// DefaultConfig are a set of key value pair which will be embedded in job</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// specification. These configs can be requested by the docker container before</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// execution</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// PluginConfig Value can contain valid go templates and they will be parsed at</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// runtime</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Neo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DefaultConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultConfigRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultConfigResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAnswerByName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Start&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Answers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAnswerByName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;End&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Answers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    conf </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;RANGE_START&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;RANGE_END&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultConfigResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// DefaultAssets are a set of files which will be embedded in job</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// specification in assets folder. These configs can be requested by the</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// docker container before execution.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Neo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DefaultAssets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultAssetsRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultAssetsResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultAssetsResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// override the compilation behaviour of assets - if needed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Neo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CompileAssets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CompileAssetsRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CompileAssetsResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CompileAssetsResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Assets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>All the functions are prefixed with comments to give you basic idea of what each one is doing, for advanced usage, look at other plugins used in the wild.</p><p>Few things to note:</p><ul><li><code>PluginInfo</code> is used to define a unique <code>name</code> used by your plugin to identify yourself, keep it simple. </li><li><code>PluginInfo</code> contains <code>Image</code> field that specify the docker image which Optimus will execute when needed. This is where the neo python image will go.</li><li><code>Version</code> field can be injected using build system, here we are only keeping a default value.</li><li><code>PluginType</code> in <code>PluginInfo</code> will tell of this plugin should be read as <code>Task</code> or <code>Hook</code> by Optimus core.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="building-everything"></a>Building everything<a class="hash-link" href="#building-everything" title="Direct link to heading">#</a></h3><p>Once the code is ready, to build there is a pretty nice tool available for golang <a href="https://github.com/goreleaser/goreleaser/" target="_blank" rel="noopener noreferrer">goreleaser</a>. A single configuration file will contain everything to build the docker image as well as the binary.</p><p>Put this in the root of the project as <code>.goreleaser.yml</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">builds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">dir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./task/neo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">main</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> .</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;neo&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">binary</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;optimus-neo_{{.Os}}_{{.Arch}}&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ldflags</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">w </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">X main.Version=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">.Version</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">X main.Image=ghcr.io/kushsharma/optimus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">neo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">executor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">goos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> linux</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> darwin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> windows</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">goarch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> amd64</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> arm64</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> CGO_ENABLED=0</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">archives</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">replacements</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">darwin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> darwin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">linux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> linux</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">windows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> windows</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">amd64</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amd64</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">format_overrides</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">goos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> windows</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">format</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zip</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">release</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prerelease</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> auto</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">checksum</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name_template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;checksums.txt&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">snapshot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name_template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{ .Tag }}-next&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">changelog</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> asc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">exclude</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;^docs:&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;^test:&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dockers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">goos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> linux</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">goarch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amd64</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image_templates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ghcr.io/kushsharma/optimus-task-neo-executor:latest&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ghcr.io/kushsharma/optimus-task-neo-executor:{{ .Version }}&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dockerfile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./task/neo/executor/Dockerfile</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">extra_files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> task/neo/executor</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">brews</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> optimus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugins</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kush</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      bin.install Dir[&quot;optimus-*&quot;]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kushsharma</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> homebrew</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">taps</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">license</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Apache 2.0&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Optimus plugins - [Optimus Near earth orbit tracker]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">commit_author</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Kush Sharma</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">email</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 3647166+kushsharma@users.noreply.github.com</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Please go through goreleaser documentation to understand what this config is doing but just to explain briefly</p><ul><li>It will build golang task plugin adapter for multiple platforms, archives them and release on Github</li><li>Build and push the docker image for the python neo task</li><li>Create a Formula for installing this plugin on Mac using brew</li><li>Each plugin will follow the binary naming convention as <code>optimus-&lt;pluginname&gt;_&lt;os&gt;_&lt;arch&gt;</code>. For example: <code>optimus-bq2bq_linux_amd64</code></li></ul><p>Once installed, run goreleaser using</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">goreleaser --snapshot --rm-dist</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Use this <a href="https://github.com/kushsharma/optimus-plugins" target="_blank" rel="noopener noreferrer">repository</a> as an example to see how everything fits in together. It uses github workflows to run goreleaser and publish everything.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="how-to-use"></a>How to use<a class="hash-link" href="#how-to-use" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="installing-a-plugin"></a>Installing a plugin<a class="hash-link" href="#installing-a-plugin" title="Direct link to heading">#</a></h3><p>Plugins need to be installed in Optimus server before it can be used. Optimus uses following directories for discovering plugin binaries</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./.plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">./</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;exec&gt;/</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;exec&gt;/.optimus/plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$HOME/.optimus/plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/bin</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Even though the above list of directories are involved in plugin discovery, it is advised to use <code>.plugins</code> in the current working directory of the project or optimus binary.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="server-side-installation"></a>Server-side installation<a class="hash-link" href="#server-side-installation" title="Direct link to heading">#</a></h3><p>On Server side, plugins (both binary and yaml) can be installed declaratively at runtime by listing the plugin artifacts in plugins section of server config.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus plugin </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -c config.yaml  </span><span class="token comment" style="color:#999988;font-style:italic"># This will install plugins in `.plugins` folder.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Plugin section to be added in server config:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">plugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">artifacts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain">path/to/optimus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">neo.yaml  </span><span class="token comment" style="color:#999988;font-style:italic"># http </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//</span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain">/plugins.zip </span><span class="token comment" style="color:#999988;font-style:italic"># zip </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ../transformers/optimus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bq2bq_darwin_arm64 </span><span class="token comment" style="color:#999988;font-style:italic"># relative paths</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ../transformers/optimus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">neo.yaml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="project-side-installation"></a>Project-side installation<a class="hash-link" href="#project-side-installation" title="Direct link to heading">#</a></h3><p>On the project side, where optimus cli is used to generate specifications or deployment, optimus cli can sync the yaml plugins supported-and-served by optimus server (with host as declared in project config).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus plugin </span><span class="token function" style="color:#d73a49">sync</span><span class="token plain"> -c optimus.yaml    </span><span class="token comment" style="color:#999988;font-style:italic"># This will install plugins in `.plugins` folder.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="using-in-job-specification"></a>Using in job specification<a class="hash-link" href="#using-in-job-specification" title="Direct link to heading">#</a></h3><p>Once everything is built and in place, we can generate job specifications that uses <strong>neo</strong> as the task type.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus create job</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? What is the job name? is_last_day_on_earth</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Who is the owner of this job? kush.sharma@example.io</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Which task to run? neo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Specify the start </span><span class="token function" style="color:#d73a49">date</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-05-25</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Specify the interval </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">in </span><span class="token function" style="color:#d73a49">crontab</span><span class="token plain"> notation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> * * *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Transformation window daily</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Date range start </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">.DSTART</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Date range end </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">.DEND</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">job created successfully is_last_day_on_earth</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Create a commit and deploy this specification if you are using optimus with a git managed repositories or send a REST call or use GRPC, whatever floats your boat.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="checking-the-output"></a>Checking the output<a class="hash-link" href="#checking-the-output" title="Direct link to heading">#</a></h3><p>If your optimus deployment is using Airflow as the scheduling engine, open the task log and verify something like this</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">total tracking: 14</span></span><span class="token-line" style="color:#393A34"><span class="token plain">potential hazardous: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Name: (2014 KP4)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Estimated Diameter: 0.8204270649 km</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Relative Velocity: 147052.9914506647 km/h</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="additional-details"></a>Additional details<a class="hash-link" href="#additional-details" title="Direct link to heading">#</a></h2><p>A task is like a pipeline, it takes some input, it runs a procedure on the input and then produces an output. Procedure is wrapped inside the docker image, output is owned by the procedure which could be anything but input should be injected somehow by optimus or at least provide some information about where/what input is. Currently, Optimus supports two kind of inputs:</p><ul><li>Key value configuration</li><li>File assets</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="task-configuration"></a>Task Configuration<a class="hash-link" href="#task-configuration" title="Direct link to heading">#</a></h5><p>Task configurations are key value pair provided as part of job specification in <code>job.yaml</code> file. These are based on plugin implementation of <code>TaskPlugin</code> interface. These configurations accept simple strings as well as Optimus <a href="/optimus/docs/concepts/overview#Macros-&amp;-Templates">macros</a>. There are few Optimus provided configuration to all tasks and hooks even if users don&#x27;t specifically provide them:</p><ul><li>DSTART</li><li>DEND</li><li>EXECUTION_TIME</li></ul><p>Secrets can be used in the task configuration by using macros like <code>SECRET_PATH: &quot;{{.secret.api_key_path}}&quot;</code>.
Where <code>api_key_path</code> is a value stored inside secrets. This configuration in macros will be replaced by optimus serer while sending a request to the plugin with actual value and can be used by the plugin. In the executor of the plugin, this configuration will be made available as environment variable.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="file-assets"></a>File Assets<a class="hash-link" href="#file-assets" title="Direct link to heading">#</a></h5><p>Sometimes a task may need more than just key value configuration, this is where assets can be used. Assets are packed along with the job specification and should have unique names. A task can have more than one asset file but if any file name conflicts with any already existing plugin in the optimus, it will throw an error, so it is advised to either prefix them or name them very specific to the task. These assets should ideally be small and not more than ~5 MB and any heavy lifting if required should be done directly inside the task container.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="requesting-task-context"></a>Requesting task context<a class="hash-link" href="#requesting-task-context" title="Direct link to heading">#</a></h3><p>Optimus calls these task configuration and asset inputs for each scheduled execution of a task as <code>context</code>. There are variety of ways to fetch task context from optimus.</p><ul><li>REST API</li><li>GRPC function call</li><li>Optimus cli</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="rest-api"></a>REST API<a class="hash-link" href="#rest-api" title="Direct link to heading">#</a></h5><p>This is probably the easiest way using <a href="https://github.com/odpf/optimus/blob/0ab5a4d44a7b2b85e9a160aef3648d8ba798536a/third_party/OpenAPI/odpf/optimus/runtime_service.swagger.json#L187" target="_blank" rel="noopener noreferrer">REST API</a> provided by optimus server. Each container when boots up has few pre-defined environment variables injected by optimus, few of them are:</p><ul><li>JOB_NAME</li><li>OPTIMUS_HOSTNAME</li><li>JOB_DIR</li><li>PROJECT</li><li>SCHEDULED_AT</li><li>INSTANCE_TYPE</li><li>INSTANCE_NAME</li></ul><p>These variables might be needed to make the call and in response, container should get configuration and files as key value pairs in json.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="grpc-call"></a>GRPC call<a class="hash-link" href="#grpc-call" title="Direct link to heading">#</a></h5><p>Plugin can choose to make a GRPC call using <code>RegisterInstance</code> <a href="https://github.com/odpf/proton/blob/main/odpf/optimus/runtime_service.proto#L124" target="_blank" rel="noopener noreferrer">function</a> and should get the context back in return.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="optimus-cli"></a>Optimus cli<a class="hash-link" href="#optimus-cli" title="Direct link to heading">#</a></h5><p>There could be scenarios where it is not possible or maybe not convenient to modify the base execution image and still task need context configuration values. One easy way to do this is by wrapping the base docker image into another docker image and using optimus binary to request task context. Optimus command will internally send a GRPC call and store the output in <code>${JOB_DIR}/in/</code> directory. It will create one <code>.env</code> file containing all the configurations, one <code>.secret</code> file with environment variables with potentially sensitive values, and all the asset files belong to the provided task. Optimus command can be invoked as</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">OPTIMUS_ADMIN_ENABLED</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> /opt/optimus admin build instance </span><span class="token variable" style="color:#36acaa">$JOB_NAME</span><span class="token plain"> --project </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> --output-dir </span><span class="token variable" style="color:#36acaa">$JOB_DIR</span><span class="token plain"> --type </span><span class="token variable" style="color:#36acaa">$INSTANCE_TYPE</span><span class="token plain"> --name </span><span class="token variable" style="color:#36acaa">$INSTANCE_NAME</span><span class="token plain"> --scheduled-at </span><span class="token variable" style="color:#36acaa">$SCHEDULED_AT</span><span class="token plain"> --host </span><span class="token variable" style="color:#36acaa">$OPTIMUS_HOSTNAME</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You might have noticed, optimus need OPTIMUS_ADMIN_ENABLED as env variable to enable admin commands. An example of wrapper <code>Dockerfile</code> is as follows</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly dockerfile"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ghcr.io/kushsharma/optimus-task-neo-executor:latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># path to optimus release tar.gz</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ARG OPTIMUS_RELEASE_URL</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apt install curl tar -y</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir -p /opt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN curl -sL ${OPTIMUS_RELEASE_URL} | tar xvz optimus</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mv optimus /opt/optimus || true</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN chmod +x /opt/optimus</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># or copy like this</span></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY task/neo/example.entrypoint.sh /opt/entrypoint.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN chmod +x /opt/entrypoint.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT [&quot;/opt/entrypoint.sh&quot;]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [&quot;python3&quot;, &quot;/opt/main.py&quot;]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Where <code>entrypoint.sh</code> is as follows</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/sh</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># wait for few seconds to prepare scheduler for the run</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># get resources</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-- initializing optimus assets&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">OPTIMUS_ADMIN_ENABLED</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> /opt/optimus admin build instance </span><span class="token variable" style="color:#36acaa">$JOB_NAME</span><span class="token plain"> --project </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> --output-dir </span><span class="token variable" style="color:#36acaa">$JOB_DIR</span><span class="token plain"> --type </span><span class="token variable" style="color:#36acaa">$TASK_TYPE</span><span class="token plain"> --name </span><span class="token variable" style="color:#36acaa">$TASK_NAME</span><span class="token plain"> --scheduled-at </span><span class="token variable" style="color:#36acaa">$SCHEDULED_AT</span><span class="token plain"> --host </span><span class="token variable" style="color:#36acaa">$OPTIMUS_HOSTNAME</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TODO: this doesnt support using back quote sign in env vars</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-- exporting env&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -o allexport</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$JOB_DIR</span><span class="token plain">/in/.env</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> +o allexport</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-- current envs&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">printenv</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-- exporting secret envs&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -o allexport</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$JOB_DIR</span><span class="token plain">/in/.secret</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> +o allexport</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-- running unit&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">eval</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$@</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>All of it can be built using goreleaser as well</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">dockers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">goos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> linux</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">goarch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amd64</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image_templates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ghcr.io/kushsharma/optimus-task-neo:latest&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ghcr.io/kushsharma/optimus-task-neo:{{ .Version }}&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">dockerfile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./task/neo/example.Dockerfile</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">extra_files</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> task/neo/example.entrypoint.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">build_flag_templates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;--build-arg=OPTIMUS_RELEASE_URL=https://github.com/odpf/optimus/releases/download/v0.0.1-rc.2/optimus_0.0.1-rc.2_linux_x86_64.tar.gz&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Keep in mind, the plugin binary now needs to point to this <code>optimus-task-neo</code> docker image and not the base one. An example of this approach can be checked in the provided <a href="https://github.com/kushsharma/optimus-plugins" target="_blank" rel="noopener noreferrer">repository</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="directory-structure"></a>Directory Structure<a class="hash-link" href="#directory-structure" title="Direct link to heading">#</a></h3><p>You might have already understood it by now but still just to state, the reason we went ahead with the provided directory structure earlier so that we can support more than one task and even hooks if we need to in the same repository. Image a single repository of plugins as an organization repository where one can find all that can be contributed by an entity</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/task</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /neo</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /executor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /main.py</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /requirements.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      /Dockerfile</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /main.go</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /go.mod</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /go.sum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /task-2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /task-3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/hook</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /hook-1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /hook-2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">.goreleaser.yml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">README.md</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="secret-management"></a>Secret management<a class="hash-link" href="#secret-management" title="Direct link to heading">#</a></h3><p>You must be wondering from where that api token came from when we said it will be mounted inside the container. Optimus need to somehow know what the secret is, for this current implementation of optimus relies on Kubernetes <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer">Secrets</a>. Optimus is built to be deployed on kubernetes, although it can work just fine without it as well but might need some tweaking here and there. An example of creating this secret </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> optimus</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">neo</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Opaque</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">key.json</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> base64encodedAPIkeygoes</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Notice the name of the secret <code>optimus-task-neo</code> which is actually based on a convention. That is if secret is defined, Optimus will look in kubernetes using <code>optimus-task-&lt;taskname&gt;</code> as the secret name and mount it to the path provided in <code>SecretPath</code> field of <code>PluginInfo</code>.</p><p>There is also a new way to using secrets in the job for a plugin or otherwise, we can store a user defined secret in the optimus server with the following command</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus secret </span><span class="token builtin class-name">set</span><span class="token plain"> secret_name </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">secret_value</span><span class="token operator" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Verify if the secret is registered properly with optimus server using following command</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus secret list</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It should list the secret registered above.</p><p>Then we can mention the secret in the job spec configuration like mentioned in the Task Configuration section. The configuration with secrets will be made available to the calls to plugins on dependency mod, and set as environment variable in the executor used by the scheduler.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/odpf/optimus/edit/master/docs/docs/development/building-plugin.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated on <b><time datetime="2023-02-08T08:13:35.000Z">2/8/2023</time></b> by <b>Arinda Arif</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/optimus/docs/concepts/intervals-and-windows"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Understanding Intervals and Windows</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/optimus/docs/contribute/contributing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Contributing »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#types-of-plugins-in-optimus" class="table-of-contents__link">Types of Plugins in Optimus</a></li><li><a href="#supported-use-cases-of-plugins-in-optimus" class="table-of-contents__link">Supported Use-Cases of Plugins in Optimus</a></li><li><a href="#binary-implementation-of-plugin" class="table-of-contents__link">Binary Implementation of Plugin</a></li><li><a href="#yaml-implementation-of-plugin" class="table-of-contents__link">Yaml Implementation of Plugin</a><ul><li><a href="#limitations-of-yaml-plugins" class="table-of-contents__link">Limitations of Yaml plugins:</a></li><li><a href="#validating-yaml-plugins" class="table-of-contents__link">Validating Yaml plugins:</a></li></ul></li><li><a href="#creating-plugin--tutorial" class="table-of-contents__link">Creating Plugin : Tutorial</a><ul><li><a href="#1-preparing-task-executor" class="table-of-contents__link">1. Preparing task executor</a></li><li><a href="#2a-creating-a-yaml-plugin" class="table-of-contents__link">2a. Creating a yaml plugin</a></li><li><a href="#2b-creating-a-binary-plugin" class="table-of-contents__link">2b. Creating a binary plugin</a></li><li><a href="#building-everything" class="table-of-contents__link">Building everything</a></li></ul></li><li><a href="#how-to-use" class="table-of-contents__link">How to use</a><ul><li><a href="#installing-a-plugin" class="table-of-contents__link">Installing a plugin</a></li><li><a href="#server-side-installation" class="table-of-contents__link">Server-side installation</a></li><li><a href="#project-side-installation" class="table-of-contents__link">Project-side installation</a></li><li><a href="#using-in-job-specification" class="table-of-contents__link">Using in job specification</a></li><li><a href="#checking-the-output" class="table-of-contents__link">Checking the output</a></li></ul></li><li><a href="#additional-details" class="table-of-contents__link">Additional details</a><ul><li><a href="#requesting-task-context" class="table-of-contents__link">Requesting task context</a></li><li><a href="#directory-structure" class="table-of-contents__link">Directory Structure</a></li><li><a href="#secret-management" class="table-of-contents__link">Secret management</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Products</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/odpf/meteor" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Meteor<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/firehose" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Firehose<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/raccoon" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Raccoon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://odpf.github.io/dagger/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Dagger<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/optimus/docs/introduction">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/help">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2020-2023 ODPF</div></div></div></footer></div>
<script src="/optimus/assets/js/runtime~main.c4e32d73.js"></script>
<script src="/optimus/assets/js/main.40830ef5.js"></script>
</body>
</html>