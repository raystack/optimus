<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/optimus/blog/rss.xml" title="Optimus Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/optimus/blog/atom.xml" title="Optimus Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RSCK0YREFM"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RSCK0YREFM",{})</script><title data-react-helmet="true">secret_management | Optimus</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://odpf.github.io/optimus/docs/rfcs/secret_management"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="secret_management | Optimus"><meta data-react-helmet="true" name="description" content="- Feature Name: Secret Management"><meta data-react-helmet="true" property="og:description" content="- Feature Name: Secret Management"><link data-react-helmet="true" rel="shortcut icon" href="/optimus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://odpf.github.io/optimus/docs/rfcs/secret_management"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/rfcs/secret_management" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/rfcs/secret_management" hreflang="x-default"><link rel="stylesheet" href="/optimus/assets/css/styles.7914c5d7.css">
<link rel="preload" href="/optimus/assets/js/runtime~main.f69ec992.js" as="script">
<link rel="preload" href="/optimus/assets/js/main.40830ef5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#222;color:#eee" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">⭐️ If you like Optimus, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/odpf/optimus">GitHub</a>! ⭐</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/optimus/"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Optimus</b></a><a class="navbar__item navbar__link" href="/optimus/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/optimus/blog">Blog</a><a class="navbar__item navbar__link" href="/optimus/help">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link"></a><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-item-github"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">☾</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">☀️</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>secret_management</h1></header><ul><li>Feature Name: Secret Management</li><li>Status: Approved</li><li>Start Date: 2021-10-02</li><li>Authors: Kush Sharma &amp; Sravan </li></ul><header><h1>Summary</h1></header><p>A lot of transformation operations require credentials to execute, there is a need to have a convenient way to save secrets and then access them in containers during the execution. This secret may also be needed in plugin adapters to compute dependencies/compile assets/etc before the actual transformation even begin. This is currently done using registering a secret to optimus so that it can be accessed by plugins and Kubernetes opaque secret, a single secret per plugin, getting mounted in the container(i.e. not at individual job level).</p><p>This can be solved by allowing users to register secret from Optimus CLI as a key value pair, storing them encrypted using a single key across all tenants.</p><header><h1>Technical Design</h1></header><p>To keep string literals as secret, it is a requirement Optimus keep them encrypted in database. Optimus Server Key is used to encrypt &amp; decrypt the secret &amp; will ensure the secret is encrypted at rest. Each secret is a key value pair where key is an alpha numeric literal and value is base64 encoded string. </p><p>Optimus has two sets of secrets, user managed secrets &amp; others which are needed for server operations. Each of server managed secrets should be prefixed by <code>_OPTIMUS_&lt;key name&gt;</code> and will not be allowed to be used by users in the job spec. Optimus should also disallow anyone using this prefix to register their secrets. The secrets can be namespaced by optimus namespace or at project level, and will be accessible accordingly. Secret names should be maintained unique across a project.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="using-secrets"></a>Using secrets<a class="hash-link" href="#using-secrets" title="Direct link to heading">#</a></h4><p>Secrets can be used as part of the job spec config using macros with their names. This will work as aliasing the secret to be used in containers. Only the secrets created at project &amp; namespace the job belongs to can be referenced. So, for the plugin writers any secret that plugin needs can be accessed through environment variables defined in the job spec or can get the secrets by defining in any assets.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">do</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> this</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">dsn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .secret.postgres_dsn </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>One thing to note is currently we print all the container environment variables using <code>printenv</code> command as debug. This should be removed after this RFC is merged to avoid exposing secrets in container logs.</p><p>Only the admins &amp; containers to be authorized for <code>registerinstance</code> end point, as this will allow access to all secrets.</p><p>Because Optimus is deployed in trusted network, we don&#x27;t need TLS for now to fetch job secrets but once Optimus is deployed as a service on edge network, this communication should only happen over TLS. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="authentication--authorization"></a>Authentication &amp; Authorization<a class="hash-link" href="#authentication--authorization" title="Direct link to heading">#</a></h4><p>Even though Optimus doesn&#x27;t have its own authentication, expect users to bring in their own auth proxy infront of Optimus. All user access &amp; container access will be restricted through the auth proxy. The corresponding secret through which the containers running in the kubernetes cluster will be authenticated need to be precreated per project.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="optimus-cli"></a>Optimus CLI<a class="hash-link" href="#optimus-cli" title="Direct link to heading">#</a></h3><p>User interaction to manage a secret will start from CLI. Users can create/update/list/delete a secret as follows</p><p>By default secrets will be created under their namespace, but optionally the secret can be created at project level by not providing any namespace while creation. This is needed if users want to allow access across entire project.</p><p>Secrets can be accessed by providing the project &amp; namespace the secret is created in, if the secret is created at project level then namespace can be set to empty string if optimus.yaml already has the namespace configured.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="createupdate"></a>Create/Update<a class="hash-link" href="#createupdate" title="Direct link to heading">#</a></h4><p><code>optimus secret create/update &lt;name&gt; &lt;value&gt; </code> will take a secret name and value</p><p><code>optimus secret create/update &lt;name&gt; --file=&quot;path&quot;</code> should read the file content as value. </p><p>Additional flag <code>--base64</code> can  be provided by user stating the value is already encoded, if not provided optimus ensures to encode &amp; store it, basic checks can be done to check if the string is a valid base64 encoded string.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="delete"></a>Delete<a class="hash-link" href="#delete" title="Direct link to heading">#</a></h4><p><code>optimus secret delete &lt;name&gt;</code> </p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="list"></a>List<a class="hash-link" href="#list" title="Direct link to heading">#</a></h4><p><code>optimus secret list</code> to list all created secrets in a project/namespace, along with the creation/updated time, will be helpful such that users can use in the job spec, as users might forget the key name, this will not list the system managed secrets.</p><p>List operation will print a digest of the secret. Digest should be a SHA hash of the encrypted string to simply visualize it as a signature when a secret is changed or the key gets rotated.</p><p> Example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">     NAME     |              DIGEST              |  NAMESPACE |  DATE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  SECRET_1    | 6c463e806738046ff3c78a08d8bd2b70 |     *      | 2021-10-06 02:02:02</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  SECRET_2    | 3aa788a21a76651c349ceeee76f1cb76 |   finance  | 2021-10-06 06:02:02</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  SECRET_2    | 3aa788a21a76651c349ceeee76f1cb76 |  transport | 2021-10-06 06:02:02</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This command will only shows the user managed secret sets and ignoring the system managed secret, while on the REST response
both sets can be shown. An additional field in secret table called &#x27;TYPE&#x27; can be added to differentiate the two sets. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="using-secrets-without-optimus"></a>Using secrets without Optimus<a class="hash-link" href="#using-secrets-without-optimus" title="Direct link to heading">#</a></h3><p>If someone wants to pass an exclusive secret without registering it with Optimus first, that should also be possible. </p><ul><li>In case of k8s: this can be done using a new field introduced in Job spec as <code>metadata</code> which will allow users to mount arbitrary secrets inside the container available in the same k8s namespace.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="rotating-optimus-server-key"></a>Rotating Optimus Server key<a class="hash-link" href="#rotating-optimus-server-key" title="Direct link to heading">#</a></h3><p>There is a need for rotating Optimus Server Key when it is compromised. As the server key is configured through environment variable, the rotation can happen by configuring through environment variables. There can be two environment variables for server keys <code>OLD_APP_KEY</code> &amp; <code>APP_KEY</code>. During startup sha of the <code>OLD_APP_KEY</code> is compared with the sha stored in the database, if it matches then rotation will happen and at the end of rotation the sha will be replaced with  <code>APP_KEY&#x27;s</code> sha. The comparision is needed to check to not attempt rotation during restarts. If there are multiple replicas then as we do this in a transaction only one succeeds.</p><p>This step will internally loading all the secrets that belong to a project to memory, decrypting it with the old_key, and encrypting it with the new key, the entire operation will happen in a single db transaction.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="migration"></a>Migration<a class="hash-link" href="#migration" title="Direct link to heading">#</a></h4><ul><li>This design will be a breaking change compare to how the secrets are handled and will require all the current secrets to be registered again.
Current system managed secrets will be re-registered using <code>_OPTIMUS_</code> prefix. Plugin secrets will also need to be registered to Optimus.</li></ul><header><h1>Footnotes &amp; References</h1></header><ul><li>Multi party encryption via <a href="https://github.com/FiloSottile/age" target="_blank" rel="noopener noreferrer">age</a></li><li><a href="https://gocloud.dev/howto/secrets/" target="_blank" rel="noopener noreferrer">Key Management Services </a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/odpf/optimus/edit/master/docs/docs/rfcs/20211002_secret_management.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated on <b><time datetime="2023-01-19T08:44:33.000Z">1/19/2023</time></b> by <b>Sandeep Bhardwaj</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#optimus-cli" class="table-of-contents__link">Optimus CLI</a></li><li><a href="#using-secrets-without-optimus" class="table-of-contents__link">Using secrets without Optimus</a></li><li><a href="#rotating-optimus-server-key" class="table-of-contents__link">Rotating Optimus Server key</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Products</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/odpf/meteor" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Meteor<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/firehose" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Firehose<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/raccoon" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Raccoon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://odpf.github.io/dagger/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Dagger<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/optimus/docs/introduction">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/help">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2020-2023 ODPF</div></div></div></footer></div>
<script src="/optimus/assets/js/runtime~main.f69ec992.js"></script>
<script src="/optimus/assets/js/main.40830ef5.js"></script>
</body>
</html>