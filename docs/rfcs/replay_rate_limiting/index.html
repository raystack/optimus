<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/optimus/blog/rss.xml" title="Optimus Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/optimus/blog/atom.xml" title="Optimus Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RSCK0YREFM"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RSCK0YREFM",{})</script><title data-react-helmet="true">replay_rate_limiting | Optimus</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://odpf.github.io/optimus/docs/rfcs/replay_rate_limiting"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="replay_rate_limiting | Optimus"><meta data-react-helmet="true" name="description" content="- Feature Name: Replay Rate Limit"><meta data-react-helmet="true" property="og:description" content="- Feature Name: Replay Rate Limit"><link data-react-helmet="true" rel="shortcut icon" href="/optimus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://odpf.github.io/optimus/docs/rfcs/replay_rate_limiting"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/rfcs/replay_rate_limiting" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/rfcs/replay_rate_limiting" hreflang="x-default"><link rel="stylesheet" href="/optimus/assets/css/styles.7914c5d7.css">
<link rel="preload" href="/optimus/assets/js/runtime~main.1dc72a4f.js" as="script">
<link rel="preload" href="/optimus/assets/js/main.40830ef5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#222;color:#eee" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">⭐️ If you like Optimus, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/odpf/optimus">GitHub</a>! ⭐</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/optimus/"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Optimus</b></a><a class="navbar__item navbar__link" href="/optimus/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/optimus/blog">Blog</a><a class="navbar__item navbar__link" href="/optimus/help">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link"></a><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-item-github"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">☾</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">☀️</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>replay_rate_limiting</h1></header><ul><li>Feature Name: Replay Rate Limit</li><li>Status: Draft</li><li>Start Date: 2022-05-25</li><li>Authors: Arinda</li></ul><header><h1>Summary</h1></header><p>Replay is using the same scheduler pool and executor slots as the scheduled jobs. Current Replay is predicted to be
causing issues and impacting the scheduled jobs, which might impacting the SLA of users. There should be a mechanism to
use a different pool and slots and configurable by the users so any backfilling will not impact and causing delay of
the scheduled jobs.</p><header><h1>Technical Design</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="background-"></a>Background :<a class="hash-link" href="#background-" title="Direct link to heading">#</a></h2><p>Currently, for bq2bq task the job is being executed using the project that specified in EXECUTION_PROJECT. This is also
applied when the jobs are run through replay command. How Replay works is by clearing runs of the requested jobs and its
dependency (if required), and there is no difference between the process of scheduled/manual job and replay. This also
means the execution project and scheduler pool is also the same.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="approach-"></a>Approach :<a class="hash-link" href="#approach-" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="reduce-the-load-of-execution-project"></a>Reduce the load of Execution Project<a class="hash-link" href="#reduce-the-load-of-execution-project" title="Direct link to heading">#</a></h3><ul><li>There will be <code>REPLAY_EXECUTION_PROJECT</code> configuration, it can be set through the task config, project or namespace config.</li><li>When building instances, Optimus will check if there is a replay request for the particular job and date, if yes,
<code>EXECUTION_PROJECT</code> will be replaced with <code>REPLAY_EXECUTION_PROJECT</code>.</li></ul><p>In job specs, task level:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bq2bq</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">PROJECT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">project</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">DATASET</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample_dataset</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">TABLE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample_table</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">SQL_TYPE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> STANDARD</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">LOAD_METHOD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> REPLACE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">EXECUTION_PROJECT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> main</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">executor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">project</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">REPLAY_EXECUTION_PROJECT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> replay</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">executor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">project</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="reduce-the-load-of-airflow-default-pool"></a>Reduce the load of Airflow Default Pool<a class="hash-link" href="#reduce-the-load-of-airflow-default-pool" title="Direct link to heading">#</a></h3><p>Initially, there are 3 mechanism to be considered for this.</p><ol><li>Differentiating Airflow pool for Replay.</li><li>Trigger a new run for Replay (not using current clear method).</li><li>Limit the slot through Optimus.</li></ol><p><strong>For the first option</strong>, Airflow pool is configured through DAG. This approach requires task to be configured using
each of the expected pool, for example <code>bq2bq-default</code> and <code>bq2bq-replay</code>. The task to be selected is being decided
using <code>BranchPythonOperator</code>. This is not preferred as there will numerous task being set and visualize, and might
confuse users.</p><p><strong>For the second option</strong>, the replay run is being triggered using API, not by using the clear run method. However,
Airflow is not accepting a pool configuration, thus it will still goes to the same pool.</p><p><strong>The third option</strong>, is limiting the slot through Optimus. There will be configuration in project level to set the
number of slots Replay can occupy.</p><p>Project configuration</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">project</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">project</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">storage_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//sample</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">bucket</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">max_replay_runs_per_project</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">max_replay_runs_per_dag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Lets say there is only 15 Replay slots at a time, and there are 40 runs requests comes. Replay will clear the first 15,
put the rest 25 in queue, and Replay will keep checking on some interval, of whether the process has been completed and
can take another runs.</p><p>Picking which runs to be processed:</p><ul><li>Based on Replay request time (FIFO)</li><li>Based on the slot per dag. If the overall is set to 15 but the slot per dag is only 5, then a request to replay a job
that has 10 runs cannot be done in one go.</li></ul><p>There should be a default value for each of the configuration.</p><ul><li>Max_replay_runs_per_project: default 10</li><li>Max_replay_runs_per_dag: default 5</li></ul><p>Optimus will check on how many Replay job is currently running, and how many task run is running for each job. Additional
changes might be needed on Replay side for optimization, to avoid calling Airflow API in every interval (Replay syncer
responsibility) and fetch data from Replay table instead.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/odpf/optimus/edit/master/docs/docs/rfcs/20220525_replay_rate_limiting.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated on <b><time datetime="2023-01-17T04:55:57.000Z">1/17/2023</time></b> by <b>Arinda Arif</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background-" class="table-of-contents__link">Background :</a></li><li><a href="#approach-" class="table-of-contents__link">Approach :</a><ul><li><a href="#reduce-the-load-of-execution-project" class="table-of-contents__link">Reduce the load of Execution Project</a></li><li><a href="#reduce-the-load-of-airflow-default-pool" class="table-of-contents__link">Reduce the load of Airflow Default Pool</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Products</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/odpf/meteor" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Meteor<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/firehose" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Firehose<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/raccoon" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Raccoon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://odpf.github.io/dagger/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Dagger<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/optimus/docs/introduction">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/help">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2020-2023 ODPF</div></div></div></footer></div>
<script src="/optimus/assets/js/runtime~main.1dc72a4f.js"></script>
<script src="/optimus/assets/js/main.40830ef5.js"></script>
</body>
</html>