<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/optimus/blog/rss.xml" title="Optimus Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/optimus/blog/atom.xml" title="Optimus Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RSCK0YREFM"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RSCK0YREFM",{})</script><title data-react-helmet="true">improving_time_and_flow_of_deployment | Optimus</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://odpf.github.io/optimus/docs/rfcs/improving_time_and_flow_of_deployment"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="improving_time_and_flow_of_deployment | Optimus"><meta data-react-helmet="true" name="description" content="- Feature Name: Improve Time &amp; Flow of the core Optimus Job Deployment, Replay, and Backup"><meta data-react-helmet="true" property="og:description" content="- Feature Name: Improve Time &amp; Flow of the core Optimus Job Deployment, Replay, and Backup"><link data-react-helmet="true" rel="shortcut icon" href="/optimus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://odpf.github.io/optimus/docs/rfcs/improving_time_and_flow_of_deployment"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/rfcs/improving_time_and_flow_of_deployment" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/docs/rfcs/improving_time_and_flow_of_deployment" hreflang="x-default"><link rel="stylesheet" href="/optimus/assets/css/styles.7914c5d7.css">
<link rel="preload" href="/optimus/assets/js/runtime~main.fdfe09da.js" as="script">
<link rel="preload" href="/optimus/assets/js/main.40830ef5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#222;color:#eee" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">⭐️ If you like Optimus, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/odpf/optimus">GitHub</a>! ⭐</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/optimus/"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/optimus/img/logo.svg" alt="Optimus" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Optimus</b></a><a class="navbar__item navbar__link" href="/optimus/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/optimus/blog">Blog</a><a class="navbar__item navbar__link" href="/optimus/help">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link"></a><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-item-github"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">☾</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">☀️</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>improving_time_and_flow_of_deployment</h1></header><ul><li>Feature Name: Improve Time &amp; Flow of the core Optimus Job Deployment, Replay, and Backup</li><li>Status: Draft</li><li>Start Date: 2022-02-16</li><li>Authors: Arinda &amp; Sravan</li></ul><header><h1>Summary</h1></header><p>It is observed that the deployment of a project with more than 1000 jobs took around 6 minutes to complete, and the
replay request for the same project took around 4 minutes. An analysis to improve the time taken for this is needed,
especially if the project will be broke down to multiple namespaces. This will cause problem, as 10 namespaces might
can consume 6 minutes * 10 times.</p><header><h1>Technical Design</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="background-"></a>Background :<a class="hash-link" href="#background-" title="Direct link to heading">#</a></h2><p>Understanding the current process of the mentioned issues:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="deploy"></a>Deploy<a class="hash-link" href="#deploy" title="Direct link to heading">#</a></h3><ul><li>Resolving dependencies for all the jobs in the requested project</li><li>Resolving priorities for all the jobs</li><li>Compiling the jobs within requested namespace</li><li>Uploading compiled jobs to storage</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="replay-request"></a>Replay Request<a class="hash-link" href="#replay-request" title="Direct link to heading">#</a></h3><ul><li>Resolving dependencies for all the jobs in the requested project</li><li>Clearing scheduler dag run(s)</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="backup-request"></a>Backup Request<a class="hash-link" href="#backup-request" title="Direct link to heading">#</a></h3><ul><li>Resolving dependencies for all the jobs in the requested project</li><li>Duplicate table</li></ul><p>All the processes above need dependency resolution. When resolving dependency, it is being done for ALL the jobs in the
project, regardless of the namespace and regardless if it has changed or not. For every job (bq2bq for example), Optimus
will call each of the jobs the GenerateDependencies function in the plugin, and do a dry run hitting the Bigquery API.
This process has been done in parallel.</p><p>To simulate, let’s say there are 1000 bq2bq jobs in a project.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    Job     |   Upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    A       |   -</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    B       |   A</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    C       |   A, B</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    D       |   C       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...     |   ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>There is a change in job C, that it no longer has dependency to job A. When it happens, when deploying, currently
Optimus will resolve dependencies for all 1000 jobs. While in fact, the changed dependencies will only happen for job C.
There is only a slight difference where upstream is no longer A and B but only B.</p><p>Currently, Optimus is resolving dependencies every time it is needed because it is not stored anywhere, due to keep
changing dependencies. However, now we are seeing a timing problem, and the fact that not all jobs need to be dependency
resolved everytime there’s a deployment, a modification can be considered.</p><p>As part of this issue, we are also revisiting the current flow of job deployment process.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="expected-behavior"></a>Expected Behavior<a class="hash-link" href="#expected-behavior" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="deploy-job"></a>Deploy Job<a class="hash-link" href="#deploy-job" title="Direct link to heading">#</a></h3><p>Accepts the whole state of the namespace/project. What is not available will be deleted.</p><ul><li>Identify the added / modified / deleted jobs</li><li>Resolve dependency only for the added or modified jobs and persist the dependency to DB</li><li>Do priority resolution for all jobs in the project</li><li>Compile all jobs in the project</li><li>Upload the compiled jobs</li></ul><p>The difference between the expected behavior and current implementation is that we will only resolve dependency for
what are necessary, and we will compile all the jobs in the project regardless the namespace. Compile and deploy all
jobs in the project is necessary to avoid below use case:</p><p>Let&#x27;s say in a single project, lies these 4 jobs. Job C depend on Job B, job B depend on Job A, and Job A and Job D are
independent. Notice that Job C is in a different namespace.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Job A (Namespace 1)             : weight 100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|-- Job B (Namespace 1)         : weight 90</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-- Job C (Namespace 2)     : weight 80</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|-- Job D (Namespace 1)         : weight 100</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now let&#x27;s say Job E (Namespace 1) is introduced and Job B is no longer depend directly on Job A, but instead to the new
Job E.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Job A (Namespace 1)             : weight 100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|-- Job E (Namespace 1)         : weight 90</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-- Job B (Namespace 1)     : weight 80</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-- Job C (Namespace 2) : weight 70</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|-- Job D (Namespace 1)         : weight 100</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Notice that Job C priority weight has been changed. This example shows that even though the changes are in Namespace 1,
the other namespace is also affected and needs to be recompiled and deployed.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-job"></a>Create Job<a class="hash-link" href="#create-job" title="Direct link to heading">#</a></h3><p>Accept a single/multiple jobs to be created and deployed.</p><ul><li>Resolve dependency for the requested job and persist the dependency to DB</li><li>Do priority resolution for all jobs in the project</li><li>Compile all jobs in the project</li><li>Upload the compiled jobs</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="delete-job"></a>Delete Job<a class="hash-link" href="#delete-job" title="Direct link to heading">#</a></h3><ul><li>Identify any dependent jobs using dependencies table</li><li>Delete only if there are no dependencies
TBD: Doing soft delete or move the deleted jobs to a different table</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="refresh-job"></a>Refresh Job<a class="hash-link" href="#refresh-job" title="Direct link to heading">#</a></h3><p>Using current state of job that has been stored, redo the dependency resolution, recompile, redeploy.
Can be useful to do clean deploy or upgrading jobs.</p><ul><li>Resolve dependency for all jobs in the namespace/project and persist to DB</li><li>Do priority resolution for all jobs in the project</li><li>Compile all jobs in the project</li><li>Upload the compiled jobs</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-resource"></a>Create Resource<a class="hash-link" href="#create-resource" title="Direct link to heading">#</a></h3><ul><li>Deploy the requested resource</li><li>Identify jobs that are dependent to the resource</li><li>Resolve dependency for the jobs found</li><li>Compile all jobs in the project</li><li>Upload the compiled jobs
An explanation of this behaviour can be found in <code>Handling Modified View</code> section</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="delete-resource"></a>Delete Resource<a class="hash-link" href="#delete-resource" title="Direct link to heading">#</a></h3><ul><li>Identify jobs that are dependent to the requested resource</li><li>Delete only if there are no dependencies</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="replay--backup"></a>Replay &amp; Backup<a class="hash-link" href="#replay--backup" title="Direct link to heading">#</a></h3><ul><li>Get the dependencies from the dependencies table.</li><li>Continue to build the tree.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="approach-"></a>Approach :<a class="hash-link" href="#approach-" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="checking-which-jobs-are-modified"></a>Checking which jobs are modified?<a class="hash-link" href="#checking-which-jobs-are-modified" title="Direct link to heading">#</a></h3><p>Currently, Optimus receives all the jobs to be deployed, compares which one to be deleted and which one to keep,
resolves and compiles them all. Optimus does not know the state of which changed.</p><p>One of the possibilities is by using Job hash. Fetch the jobs from DB, hash and compare with the one requested.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="persistence"></a>Persistence<a class="hash-link" href="#persistence" title="Direct link to heading">#</a></h3><p>The process can be optimized only if the dependencies are stored, so no need to resolve it all every time it is needed.
Currently, this is the struct of JobSpec in Optimus:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> JobSpec </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ID             uuid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UUID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name           </span><span class="token builtin">string</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Dependencies   </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">JobSpecDependency</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> JobSpecDependency </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Project </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ProjectSpec</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Job     </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">JobSpec</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type    JobSpecDependencyType</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The Dependencies field will be filled with inferred dependency after dependency resolution is finished.</p><p>We can have a new table to persist the job ID dependency.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    job_id              |   UUID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    job_dependency_id   |   UUID</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Example</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    Job     |   Upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    A       |   -</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    B       |   A</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    C       |   A</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    C       |   B</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    D       |   C</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...     |   ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If now C has been modified to have upstream of only B, means:</p><ul><li>Record with jobID C will be deleted</li><li>Insert 1 new record: C with dependency B</li></ul><p>Advantages:</p><ul><li>Data is available even though there are pod restarts.</li><li>Better visibility of current dependencies.</li></ul><p>Disadvantages:</p><ul><li>Additional time to write/read from DB</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="event-based-mechanism-in-deployment"></a>Event-Based Mechanism in Deployment<a class="hash-link" href="#event-based-mechanism-in-deployment" title="Direct link to heading">#</a></h3><p>Revisiting the process of deployment:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Step                |   Deploy      | Create Job    | Refresh</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------------------------------------------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Resolve dependency  |   Diff        | Requested     | All</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Resolve priority    |   All         | All           | All</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Compile             |   All         | All           | All</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Upload              |   All         | All           | All</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Notice that priority resolution, compilation, and upload compiled jobs needs to be done for all the jobs in the project
for all the namespaces. Each of the request can be done multiple times per minute and improvisation to speed up the
process is needed.</p><p>Whenever there is a request to do deployment, job creation, and refresh, Optimus will do dependency resolution based
on each of the cases. After it finishes, it will push an event to be picked by a worker to do priority resolution,
compilation, and upload asynchronously. There will be deduplication in the event coming in, to avoid doing duplicated
process.</p><p>There will be a get deployment status API introduced to poll whether these async processes has been finished or not.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="handling-dependency-resolution-failure"></a>Handling Dependency Resolution Failure<a class="hash-link" href="#handling-dependency-resolution-failure" title="Direct link to heading">#</a></h3><p>Currently, whenever there is a single jobs that is failing in dependency resolution, and it is within the same
namespace as requested, it will fail the entire process. We are avoiding the entire deployment pipeline to be blocked
by a single job failure, but instead sending it as part of the response and proceeding the deployment until finished.
Only the failed jobs will not be deployed. There will be metrics being added to add more visibility around this.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="handling-modified-view"></a>Handling Modified View<a class="hash-link" href="#handling-modified-view" title="Direct link to heading">#</a></h3><p>A BQ2BQ job can have a source from views. For this job, the dependency will be the underlying tables of the view. Let&#x27;s
simulate a case where there is a change in the view source.</p><p>In a project, there is view <code>X</code> that querying from table <code>A</code> and <code>B</code>. There is also table <code>C</code> that querying from View
<code>X</code>. The job dependencies for this case can be summarized as:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    Job     |   Upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    A       |   -</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    B       |   -</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    C       |   A</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    C       |   B</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Job C has dependency to job <code>A</code> and <code>B</code>, even though it is querying from view <code>X</code>.</p><p>Imagine a case where view <code>X</code> is modified, for example no longer querying from <code>A</code> and <code>B</code>, but instead only from <code>A</code>.
Job <code>C</code> dependency will never be updated, since it is not considered as modified. There should be a mechanism where if
a view is updated, it will also resolve the dependency for the jobs that depend on the view.</p><p>To make this happen, there should be a visibility of which resources are the sources of a job, for example which job is
using this view as a destination and querying from this view. Optimus is a transformation tool, in the job spec we store
what is the transformation destination of the job. However, we are not storing what are the sources of the transformation.
The only thing we have is job dependency, not resource.</p><p>We can add a Source URNs field to the jobs specs, or create a Job Source table. Whenever there is a change in a view
through Optimus, datastore should be able to request the dependency resolution for the view&#x27;s dependent and having the
dependencies updated. We will also provide the mechanism to refresh jobs.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="cli-perspective"></a>CLI Perspective<a class="hash-link" href="#cli-perspective" title="Direct link to heading">#</a></h3><p>Deploy job per namespace (using DeployJobSpecification rpc)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus job deploy --namespace --project</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Deploy job for selected jobs (using CreateJobSpecification rpc)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus job deploy --namespace --project --jobs=(job1,job2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Refresh the entire namespace/project</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus job refresh --namespace --project</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Refresh the selected jobs</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimus job refresh --namespace --project --jobs=(job1,job2)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="other-thoughts"></a>Other Thoughts:<a class="hash-link" href="#other-thoughts" title="Direct link to heading">#</a></h2><p>Cache Considerations instead of persisting to PG</p><ul><li>Might be faster as there is no additional time for write/read from DB</li><li>Data will be unavailable post pod restarts. Need to redo the dependency resolution overall</li><li>Poor visibility</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/odpf/optimus/edit/master/docs/docs/rfcs/20220216_improving_time_and_flow_of_deployment.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated on <b><time datetime="2023-01-06T12:21:17.000Z">1/6/2023</time></b> by <b>Yash Bhardwaj</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background-" class="table-of-contents__link">Background :</a><ul><li><a href="#deploy" class="table-of-contents__link">Deploy</a></li><li><a href="#replay-request" class="table-of-contents__link">Replay Request</a></li><li><a href="#backup-request" class="table-of-contents__link">Backup Request</a></li></ul></li><li><a href="#expected-behavior" class="table-of-contents__link">Expected Behavior</a><ul><li><a href="#deploy-job" class="table-of-contents__link">Deploy Job</a></li><li><a href="#create-job" class="table-of-contents__link">Create Job</a></li><li><a href="#delete-job" class="table-of-contents__link">Delete Job</a></li><li><a href="#refresh-job" class="table-of-contents__link">Refresh Job</a></li><li><a href="#create-resource" class="table-of-contents__link">Create Resource</a></li><li><a href="#delete-resource" class="table-of-contents__link">Delete Resource</a></li><li><a href="#replay--backup" class="table-of-contents__link">Replay &amp; Backup</a></li></ul></li><li><a href="#approach-" class="table-of-contents__link">Approach :</a><ul><li><a href="#checking-which-jobs-are-modified" class="table-of-contents__link">Checking which jobs are modified?</a></li><li><a href="#persistence" class="table-of-contents__link">Persistence</a></li><li><a href="#event-based-mechanism-in-deployment" class="table-of-contents__link">Event-Based Mechanism in Deployment</a></li><li><a href="#handling-dependency-resolution-failure" class="table-of-contents__link">Handling Dependency Resolution Failure</a></li><li><a href="#handling-modified-view" class="table-of-contents__link">Handling Modified View</a></li><li><a href="#cli-perspective" class="table-of-contents__link">CLI Perspective</a></li></ul></li><li><a href="#other-thoughts" class="table-of-contents__link">Other Thoughts:</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Products</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/odpf/meteor" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Meteor<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/firehose" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Firehose<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/raccoon" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Raccoon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://odpf.github.io/dagger/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Dagger<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/optimus/docs/introduction">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/optimus/help">Help</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://bit.ly/2RzPbtn" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2020-2023 ODPF</div></div></div></footer></div>
<script src="/optimus/assets/js/runtime~main.fdfe09da.js"></script>
<script src="/optimus/assets/js/main.40830ef5.js"></script>
</body>
</html>